import React, { useState, useEffect, useRef } from 'react';
import { Brain, Send, RotateCcw, Trophy, Zap, Sparkles, Code, Search, Rocket, Wand2, TrendingUp, Lightbulb, Award, MessageSquare, Activity, Settings, Key, CheckCircle, XCircle } from 'lucide-react';

const ZabbiBotTutor = () => {
  const [messages, setMessages] = useState([]);
  const [input, setInput] = useState('');
  const [conversationState, setConversationState] = useState('greeting');
  const [xp, setXp] = useState(0);
  const [streak, setStreak] = useState(1);
  const [userName, setUserName] = useState('');
  const [isAiThinking, setIsAiThinking] = useState(false);
  const [showApiConfig, setShowApiConfig] = useState(false);
  const [apiKey, setApiKey] = useState(localStorage.getItem('groq_api_key') || '');
  const [apiMode, setApiMode] = useState(localStorage.getItem('groq_api_key') ? 'ai' : 'embedded');
  
  const [superMode, setSuperMode] = useState(null);
  
  const [learningProfile, setLearningProfile] = useState({
    style: null,
    personality: null,
    focusLevel: 100,
    energy: 100,
    motivationType: null,
  });
  
  const [sessionData, setSessionData] = useState({
    startTime: Date.now(),
    interactions: 0,
    aiCallsUsed: 0,
  });

  const [conversationHistory, setConversationHistory] = useState([]);
  const [userLevel, setUserLevel] = useState(null);
  const messagesEndRef = useRef(null);

  // Base de conhecimento embutida
  const knowledgeBase = {
    zabbix: {
      definicao: "Zabbix √© uma solu√ß√£o OPEN SOURCE de monitoramento empresarial para redes e aplica√ß√µes. Monitora servidores, VMs, redes, cloud e servi√ßos. Coleta m√©tricas, detecta problemas e alerta equipes em tempo real!",
      conceitos: {
        host: "HOST √© qualquer dispositivo/sistema que voc√™ quer monitorar. Pode ser: servidor Linux/Windows, switch, roteador, impressora, container Docker, VM, at√© IoT! √â o 'QUEM' voc√™ monitora.",
        item: "ITEM √© a m√©trica espec√≠fica que voc√™ coleta de um host. Exemplos: CPU usage, RAM livre, espa√ßo em disco, temperatura, lat√™ncia de rede. √â o 'O QU√ä' voc√™ quer saber.",
        trigger: "TRIGGER √© a condi√ß√£o que define quando alertar. Exemplo: 'Se CPU > 90% por 5 minutos, ALERTA!'. √â o 'QUANDO' voc√™ deve se preocupar.",
        action: "ACTION √© o que fazer quando trigger dispara. Pode enviar email, SMS, executar script, reiniciar servi√ßo. √â o 'O QUE FAZER' quando h√° problema.",
        template: "TEMPLATE √© um conjunto reutiliz√°vel de items, triggers e graphs. Crie uma vez, aplique em v√°rios hosts! √â como receita de bolo - use quantas vezes quiser!"
      },
      instalacao: "1) Atualize sistema: sudo apt update && sudo apt upgrade -y\n2) Adicione repo Zabbix: wget https://repo.zabbix.com/zabbix/6.4/ubuntu/pool/main/z/zabbix-release/zabbix-release_6.4-1+ubuntu22.04_all.deb && sudo dpkg -i zabbix-release_6.4-1+ubuntu22.04_all.deb\n3) Instale: sudo apt update && sudo apt install zabbix-server-mysql zabbix-frontend-php zabbix-agent\n4) Configure database e inicie!",
      troubleshooting: {
        "cpu alta": "1) Verifique processos: top ou htop\n2) Identifique processo problem√°tico\n3) Analise logs do processo\n4) Considere: restart, otimiza√ß√£o, ou upgrade de hardware\n5) Configure trigger no Zabbix para alertar antes de 100%",
        "agente offline": "1) Verifique se servi√ßo est√° rodando: systemctl status zabbix-agent\n2) Teste conectividade: telnet <server> 10050\n3) Verifique firewall: sudo ufw status\n4) Confira logs: tail -f /var/log/zabbix/zabbix_agentd.log\n5) Valide config: /etc/zabbix/zabbix_agentd.conf",
        "dados n√£o coletam": "1) Verifique se item est√° habilitado\n2) Confirme que host est√° ativo\n3) Teste item manualmente: zabbix_get -s <host> -k <key>\n4) Verifique permiss√µes\n5) Analise logs do servidor"
      }
    },
    grafana: {
      definicao: "Grafana √© uma plataforma OPEN SOURCE de analytics e visualiza√ß√£o. Transforma dados brutos em dashboards LINDOS e interativos! Conecta com Zabbix, Prometheus, MySQL, PostgreSQL e 100+ datasources!",
      conceitos: {
        dashboard: "DASHBOARD √© uma cole√ß√£o de pain√©is (panels) que exibem dados visualmente. √â seu 'centro de comando' com gr√°ficos, tabelas, gauges mostrando m√©tricas em tempo real!",
        panel: "PANEL √© um componente individual do dashboard. Pode ser: gr√°fico de linha, gauge, stat, tabela, heatmap. Cada panel mostra uma m√©trica espec√≠fica.",
        datasource: "DATASOURCE √© a origem dos dados. Pode ser: Zabbix, Prometheus, MySQL, InfluxDB, Elasticsearch. Grafana busca dados de l√° e exibe nos dashboards.",
        query: "QUERY √© a pergunta que voc√™ faz ao datasource. Exemplo: 'Me d√™ CPU dos √∫ltimos 30 minutos' ou 'Mostre requests/segundo agora'. Usa linguagem espec√≠fica do datasource.",
        variable: "VARIABLE deixa dashboard din√¢mico! Em vez de criar dashboard para cada servidor, crie UMA vari√°vel $servidor e selecione qual ver. Reutiliza√ß√£o m√°xima!"
      },
      instalacao: "1) Adicione repo: sudo wget -q -O /usr/share/keyrings/grafana.key https://apt.grafana.com/gpg.key\n2) Echo repo: echo 'deb [signed-by=/usr/share/keyrings/grafana.key] https://apt.grafana.com stable main' | sudo tee /etc/apt/sources.list.d/grafana.list\n3) Instale: sudo apt update && sudo apt install grafana\n4) Inicie: sudo systemctl start grafana-server\n5) Acesse: http://localhost:3000 (user: admin, pass: admin)"
    }
  };

  const scriptTemplates = {
    "monitor docker": `#!/bin/bash
# Monitor Docker Containers
# Autor: ZabbiBot 3.0

# Verifica se Docker est√° rodando
if ! systemctl is-active --quiet docker; then
    echo "Docker n√£o est√° rodando!"
    exit 1
fi

# Lista containers e status
echo "=== CONTAINERS ATIVOS ==="
docker ps --format "table {{.Names}}\t{{.Status}}\t{{.CPUPerc}}\t{{.MemPerc}}"

# Alerta se algum container parou
STOPPED=$(docker ps -a --filter "status=exited" --format "{{.Names}}")
if [ ! -z "$STOPPED" ]; then
    echo "‚ö†Ô∏è  ALERTA: Containers parados: $STOPPED"
fi`,
    
    "check nginx": `#!/bin/bash
# Verifica e reinicia Nginx se necess√°rio
# Autor: ZabbiBot 3.0

SERVICE="nginx"
if systemctl is-active --quiet $SERVICE; then
    echo "‚úÖ $SERVICE est√° rodando"
    # Testa config
    nginx -t 2>&1
else
    echo "‚ùå $SERVICE parado! Reiniciando..."
    systemctl start $SERVICE
    if systemctl is-active --quiet $SERVICE; then
        echo "‚úÖ $SERVICE reiniciado com sucesso!"
    else
        echo "üö® FALHA ao reiniciar $SERVICE!"
        exit 1
    fi
fi`,

    "disk space alert": `#!/bin/bash
# Alerta de espa√ßo em disco
# Autor: ZabbiBot 3.0

THRESHOLD=80

df -H | grep -vE '^Filesystem|tmpfs|cdrom' | awk '{ print $5 " " $1 }' | while read output;
do
  usage=$(echo $output | awk '{ print $1}' | cut -d'%' -f1)
  partition=$(echo $output | awk '{ print $2 }')
  
  if [ $usage -ge $THRESHOLD ]; then
    echo "üö® ALERTA: Parti√ß√£o $partition est√° em ${usage}%!"
  else
    echo "‚úÖ $partition: ${usage}% (OK)"
  fi
done`
  };

  useEffect(() => {
    addBotMessage(`ü¶∏‚Äç‚ôÇÔ∏è **ZabbiBot 3.0 - Sistema H√≠brido**

${apiMode === 'ai' ? 'ü§ñ **MODO IA ATIVADO!**' : 'üß† **MODO INTELIGENTE EMBUTIDO**'}

Eu tenho:
${apiMode === 'ai' ? '‚úÖ IA Real conectada (Groq)' : '‚úÖ Base de conhecimento completa'}
‚úÖ An√°lise de c√≥digo
‚úÖ Gerador de scripts
‚úÖ Troubleshooting
‚úÖ Simulador de cen√°rios
‚úÖ Tutoriais interativos

${apiMode === 'embedded' ? 'üí° **Dica:** Quer respostas ainda melhores? Configure sua API key gratuita no √≠cone ‚öôÔ∏è!' : ''}

**Qual seu nome?** üòä`, 0);
  }, []);

  useEffect(() => {
    messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
  }, [messages]);

  const addBotMessage = (content, delay = 800) => {
    setTimeout(() => {
      setMessages(prev => [...prev, {
        type: 'bot',
        content,
        timestamp: new Date()
      }]);
    }, delay);
  };

  const addSystemMessage = (content, type = 'info') => {
    setMessages(prev => [...prev, {
      type: 'system',
      content,
      timestamp: new Date(),
      systemType: type
    }]);
  };

  const addXP = (amount, reason = '') => {
    setXp(prev => prev + amount);
    addSystemMessage(`‚ú® +${amount} XP ${reason ? `- ${reason}` : ''}! üî•`, 'success');
  };

  // Sistema h√≠brido de resposta
  const getSmartResponse = async (userQuestion, context = '') => {
    // Se tem API key, usa IA
    if (apiMode === 'ai' && apiKey) {
      return await callGroqAPI(userQuestion, context);
    }
    
    // Sen√£o, usa sistema embutido inteligente
    return getEmbeddedResponse(userQuestion, context);
  };

  // IA Real com Groq API (gratuita e sem CORS!)
  const callGroqAPI = async (userQuestion, context = '') => {
    setIsAiThinking(true);
    setSessionData(prev => ({ ...prev, aiCallsUsed: prev.aiCallsUsed + 1 }));
    
    try {
      const systemPrompt = `Voc√™ √© o ZabbiBot 3.0, tutor especialista em Zabbix e Grafana.

Perfil do aluno:
- Nome: ${userName}
- N√≠vel: ${userLevel}
- Estilo: ${learningProfile.style}
- Personalidade: ${learningProfile.personality}

Seja divertido, use emojis, explique claramente e motive o aluno!`;

      const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${apiKey}`
        },
        body: JSON.stringify({
          model: "llama-3.3-70b-versatile",
          messages: [
            { role: "system", content: systemPrompt },
            ...conversationHistory,
            { role: "user", content: userQuestion }
          ],
          temperature: 0.7,
          max_tokens: 1000
        })
      });

      if (!response.ok) {
        throw new Error(`API Error: ${response.status}`);
      }

      const data = await response.json();
      const aiResponse = data.choices[0].message.content;
      
      setConversationHistory(prev => [
        ...prev,
        { role: "user", content: userQuestion },
        { role: "assistant", content: aiResponse }
      ]);
      
      setIsAiThinking(false);
      return aiResponse;
      
    } catch (error) {
      setIsAiThinking(false);
      return `‚ùå Erro na API: ${error.message}\n\nüí° Verifique sua API key ou use modo embutido!\n\n(Clique em ‚öôÔ∏è para configurar)`;
    }
  };

  // Sistema inteligente embutido
  const getEmbeddedResponse = (userQuestion, context = '') => {
    const q = userQuestion.toLowerCase();
    
    // Detec√ß√£o inteligente de t√≥picos
    if (q.includes('zabbix') && (q.includes('o que') || q.includes('oque') || q.includes('que √©') || q.includes('define'))) {
      return `üîµ **O QUE √â ZABBIX?**\n\n${knowledgeBase.zabbix.definicao}\n\n**Por que usar?**\n‚úÖ Open source e gratuito\n‚úÖ Monitora TUDO\n‚úÖ Escal√°vel (10 a 100.000+ devices)\n‚úÖ Interface web intuitiva\n‚úÖ Alertas inteligentes\n\n**Quer saber mais?** Pergunte sobre: host, item, trigger, action, template!`;
    }
    
    if (q.includes('grafana') && (q.includes('o que') || q.includes('oque') || q.includes('que √©') || q.includes('define'))) {
      return `üü£ **O QUE √â GRAFANA?**\n\n${knowledgeBase.grafana.definicao}\n\n**Por que usar?**\n‚úÖ Dashboards LINDOS\n‚úÖ 100+ datasources\n‚úÖ Alerting integrado\n‚úÖ Mobile-friendly\n‚úÖ Plugins customizados\n\n**Quer saber mais?** Pergunte sobre: dashboard, panel, query, variable!`;
    }
    
    // Conceitos
    if (q.includes('host')) {
      return `üñ•Ô∏è **HOST NO ZABBIX:**\n\n${knowledgeBase.zabbix.conceitos.host}\n\n**Exemplos pr√°ticos:**\n‚Ä¢ Web-Server-01 (Linux)\n‚Ä¢ DB-Prod-MySQL (banco)\n‚Ä¢ Switch-Core-01 (rede)\n‚Ä¢ Docker-Host (containers)\n\n**Analogia:** Host √© como contato na agenda - voc√™ precisa "cadastrar" quem vai monitorar!`;
    }
    
    if (q.includes('item')) {
      return `üìä **ITEM NO ZABBIX:**\n\n${knowledgeBase.zabbix.conceitos.item}\n\n**Exemplos de keys:**\n‚Ä¢ system.cpu.util - CPU usage\n‚Ä¢ vm.memory.size[available] - RAM livre\n‚Ä¢ vfs.fs.size[/,used] - Disco usado\n‚Ä¢ net.if.in[eth0] - Tr√°fego entrada\n\n**Dica:** Items s√£o coletados periodicamente (ex: a cada 60 segundos)!`;
    }
    
    if (q.includes('trigger')) {
      return `üö® **TRIGGER NO ZABBIX:**\n\n${knowledgeBase.zabbix.conceitos.trigger}\n\n**Exemplo pr√°tico:**\n\`\`\`\n{Host:system.cpu.util.avg(5m)}>90\n\`\`\`\nL√™-se: "Se CPU m√©dia dos √∫ltimos 5min > 90%"\n\n**Severidades:**\nüîµ Not classified\nüü¢ Information\nüü° Warning\nüü† Average\nüî¥ High\nüî• Disaster`;
    }
    
    if (q.includes('action')) {
      return `üìß **ACTION NO ZABBIX:**\n\n${knowledgeBase.zabbix.conceitos.action}\n\n**Tipos de a√ß√£o:**\n1. **Send message** - Email/SMS\n2. **Remote command** - Executa script\n3. **Add/Remove host** - Automa√ß√£o\n\n**Exemplo:**\nTrigger: "Nginx down"\nAction: Email + restart nginx remotamente!\n\n**Dica:** Configure escalations para alertas cr√≠ticos!`;
    }
    
    if (q.includes('template')) {
      return `üìã **TEMPLATE NO ZABBIX:**\n\n${knowledgeBase.zabbix.conceitos.template}\n\n**Templates populares:**\n‚Ä¢ Linux by Zabbix agent\n‚Ä¢ Windows by Zabbix agent\n‚Ä¢ MySQL by Zabbix agent\n‚Ä¢ Docker by Zabbix agent\n‚Ä¢ Nginx by HTTP\n\n**Como usar:**\n1. Crie/Importe template\n2. Aplique em hosts\n3. Personalize se necess√°rio\n\n**Pro tip:** Templates community no Zabbix Share!`;
    }
    
    if (q.includes('dashboard') && q.includes('grafana')) {
      return `üìä **DASHBOARD NO GRAFANA:**\n\n${knowledgeBase.grafana.conceitos.dashboard}\n\n**Boas pr√°ticas:**\n‚úÖ Organize por fun√ß√£o (Overview, Details, Troubleshoot)\n‚úÖ Use cores consistentes\n‚úÖ Menos √© mais (4-8 panels ideal)\n‚úÖ Conte uma hist√≥ria com os dados\n‚úÖ Mobile-first thinking\n\n**Templates prontos:** grafana.com/dashboards`;
    }
    
    // Instala√ß√£o
    if ((q.includes('instalar') || q.includes('instala√ß√£o') || q.includes('install')) && q.includes('zabbix')) {
      return `‚ö° **INSTALA√á√ÉO ZABBIX (Ubuntu):**\n\n${knowledgeBase.zabbix.instalacao}\n\n**P√≥s-instala√ß√£o:**\n5) Acesse: http://seu-ip/zabbix\n6) Configure database\n7) Login: Admin / zabbix\n8) MUDE A SENHA!\n\n**Dica:** Use Docker para testes: docker run --name zabbix zabbix/zabbix-server-mysql`;
    }
    
    if ((q.includes('instalar') || q.includes('instala√ß√£o') || q.includes('install')) && q.includes('grafana')) {
      return `üìä **INSTALA√á√ÉO GRAFANA:**\n\n${knowledgeBase.grafana.instalacao}\n\n**Pr√≥ximos passos:**\n1. Adicione Zabbix como datasource\n2. Importe dashboard\n3. Configure alertas\n4. Customize!\n\n**Plugin Zabbix:**\ngrafana-cli plugins install alexanderzobnin-zabbix-app`;
    }
    
    // Troubleshooting
    if (q.includes('cpu') && (q.includes('alta') || q.includes('alto') || q.includes('100'))) {
      return `üîß **TROUBLESHOOT: CPU ALTA**\n\n${knowledgeBase.zabbix.troubleshooting["cpu alta"]}\n\n**Comandos √∫teis:**\n\`\`\`bash\ntop -o %CPU\nps aux --sort=-%cpu | head\n\`\`\`\n\n**Preven√ß√£o:**\n‚Ä¢ Configure trigger para 80% (warning)\n‚Ä¢ Configure trigger para 95% (critical)\n‚Ä¢ Use gr√°ficos para ver tend√™ncia`;
    }
    
    if (q.includes('agente') && (q.includes('offline') || q.includes('down') || q.includes('n√£o conecta'))) {
      return `üîß **TROUBLESHOOT: AGENTE OFFLINE**\n\n${knowledgeBase.zabbix.troubleshooting["agente offline"]}\n\n**Checklist r√°pido:**\n‚òê Servi√ßo rodando?\n‚òê Porta 10050 aberta?\n‚òê Server configurado no agentd.conf?\n‚òê Firewall liberado?\n‚òê Hostname correto?\n\n**Teste final:**\ntelnet <zabbix-server> 10050`;
    }
    
    // Respostas gen√©ricas inteligentes
    if (q.includes('diferen√ßa') || q.includes('diferenca')) {
      if (q.includes('zabbix') && q.includes('grafana')) {
        return `üÜö **ZABBIX vs GRAFANA:**\n\n**ZABBIX:**\n‚úÖ Coleta dados\n‚úÖ Detecta problemas\n‚úÖ Alerta equipes\n‚úÖ Solu√ß√£o completa\n\n**GRAFANA:**\n‚úÖ Visualiza dados\n‚úÖ Dashboards bonitos\n‚úÖ Multi-datasource\n‚úÖ Especialista em viz\n\n**JUNTOS:** Zabbix coleta, Grafana visualiza = ‚ù§Ô∏è COMBO PERFEITO!`;
      }
    }
    
    if (q.includes('como') && q.includes('come√ßar')) {
      return `üöÄ **COMO COME√áAR:**\n\n**Passo 1:** Instale Zabbix Server\n**Passo 2:** Instale Zabbix Agent nos hosts\n**Passo 3:** Configure primeiro host\n**Passo 4:** Aplique template\n**Passo 5:** Crie dashboards no Grafana\n\n**Tempo:** 1-2 horas para setup b√°sico\n\n**Quer tutorial passo a passo?** Digite: **tutorial instala√ß√£o**`;
    }
    
    // Se n√£o encontrou resposta espec√≠fica
    return `ü§î Interessante! Sobre esse t√≥pico espec√≠fico, posso te ajudar de outras formas:\n\n‚Ä¢ Digite **menu** para ver super poderes\n‚Ä¢ Digite **tutorial [t√≥pico]** para aprender\n‚Ä¢ Digite **exemplo [conceito]** para ver pr√°tica\n\n${apiMode === 'embedded' ? 'üí° **Quer respostas mais personalizadas?** Configure API key gratuita no ‚öôÔ∏è!' : ''}\n\nOu reformule sua pergunta! üòä`;
  };

  // Gerador de scripts
  const generateScript = (description) => {
    const desc = description.toLowerCase();
    
    if (desc.includes('docker')) {
      return `üõ†Ô∏è **SCRIPT: MONITOR DOCKER**\n\n${scriptTemplates["monitor docker"]}\n\n**Como usar:**\n1. Salve como monitor_docker.sh\n2. chmod +x monitor_docker.sh\n3. Execute: ./monitor_docker.sh\n4. Agende no cron se quiser!\n\n**Integra√ß√£o Zabbix:**\nUserParameter=docker.check,/path/to/monitor_docker.sh`;
    }
    
    if (desc.includes('nginx')) {
      return `üõ†Ô∏è **SCRIPT: CHECK NGINX**\n\n${scriptTemplates["check nginx"]}\n\n**Como usar:**\n1. Salve como check_nginx.sh\n2. chmod +x check_nginx.sh\n3. Execute: ./check_nginx.sh\n\n**Auto-healing!** Script reinicia automaticamente se servi√ßo cair!`;
    }
    
    if (desc.includes('disco') || desc.includes('disk')) {
      return `üõ†Ô∏è **SCRIPT: ALERTA DISCO**\n\n${scriptTemplates["disk space alert"]}\n\n**Customiza√ß√£o:**\n‚Ä¢ Mude THRESHOLD=80 para seu limite\n‚Ä¢ Adicione notifica√ß√£o (email, Slack)\n‚Ä¢ Agende no cron: */5 * * * *\n\n**Integra√ß√£o Zabbix:**\nUserParameter=disk.check,/path/to/disk_alert.sh`;
    }
    
    return `üõ†Ô∏è **TEMPLATE DE SCRIPT PERSONALIZADO**\n\n\`\`\`bash\n#!/bin/bash\n# ${description}\n# Autor: ${userName}\n\n# Seu c√≥digo aqui\necho "Script para: ${description}"\n\n# Adicione l√≥gica\n# Adicione alertas\n# Adicione logs\n\`\`\`\n\n**Pr√≥ximos passos:**\n1. Implemente l√≥gica espec√≠fica\n2. Teste em ambiente dev\n3. Adicione error handling\n4. Documente!\n\n**Precisa de ajuda?** Seja mais espec√≠fico sobre o que quer fazer!`;
  };

  // Analisador de c√≥digo
  const analyzeCode = (code) => {
    let analysis = 'üîç **AN√ÅLISE DE C√ìDIGO:**\n\n';
    
    // An√°lise b√°sica por padr√µes
    if (code.includes('sudo rm -rf')) {
      analysis += 'üö® **PERIGO:** Comando destrutivo detectado!\n';
    }
    
    if (!code.includes('#!/bin/bash') && !code.includes('#!/usr/bin/env')) {
      analysis += '‚ö†Ô∏è **Falta shebang:** Adicione #!/bin/bash no in√≠cio\n';
    }
    
    if (!code.includes('set -e') && !code.includes('set -eu')) {
      analysis += 'üí° **Sugest√£o:** Adicione `set -e` para parar em erros\n';
    }
    
    if (code.split('\n').filter(l => l.trim().startsWith('#')).length < 3) {
      analysis += 'üìù **Documenta√ß√£o:** Adicione mais coment√°rios\n';
    }
    
    if (code.includes('password') || code.includes('apikey')) {
      analysis += 'üîí **SEGURAN√áA:** N√£o hardcode senhas! Use vari√°veis de ambiente\n';
    }
    
    analysis += '\n‚úÖ **Boas pr√°ticas:**\n';
    analysis += '‚Ä¢ Use vari√°veis para valores repetidos\n';
    analysis += '‚Ä¢ Adicione valida√ß√£o de entrada\n';
    analysis += '‚Ä¢ Implemente logging\n';
    analysis += '‚Ä¢ Teste em ambiente dev primeiro\n';
    
    return analysis;
  };

  const profileQuestions = {
    learning_style: {
      question: `**Como voc√™ aprende melhor?**\n\nA) üìä Visual (gr√°ficos)\nB) üéß Auditivo (explica√ß√µes)\nC) üìù Leitura (textos)\nD) üõ†Ô∏è Pr√°tico (m√£o na massa)`,
      profiles: { A: 'visual', B: 'auditivo', C: 'reading', D: 'kinesthetic' }
    },
    personality: {
      question: `**Seu estilo:**\n\nA) üó∫Ô∏è Explorador\nB) üìã Estrategista\nC) ‚ö° Pragm√°tico\nD) üë• Social`,
      profiles: { A: 'explorador', B: 'estrategista', C: 'pragmatico', D: 'social' }
    },
    motivation: {
      question: `**O que te motiva?**\n\nA) üèÜ Conquistar\nB) üéì Dominar\nC) üîì Criar\nD) üåü Ajudar`,
      profiles: { A: 'achievement', B: 'mastery', C: 'autonomy', D: 'purpose' }
    }
  };

  const smartRespond = async (userMsg) => {
    const msg = userMsg.toLowerCase().trim();
    setSessionData(prev => ({ ...prev, interactions: prev.interactions + 1 }));

    // Estados de perfilamento
    if (conversationState === 'greeting') {
      setUserName(userMsg.trim());
      setConversationState('profiling_style');
      addXP(10, 'Bem-vindo');
      return `Prazer, **${userMsg.trim()}**! ü§ù\n\n${profileQuestions.learning_style.question}`;
    }

    if (conversationState === 'profiling_style') {
      const answer = msg.toUpperCase().replace(/[^ABCD]/g, '');
      if (['A', 'B', 'C', 'D'].includes(answer)) {
        setLearningProfile(prev => ({ ...prev, style: profileQuestions.learning_style.profiles[answer] }));
        setConversationState('profiling_personality');
        addXP(15, 'Perfil');
        return profileQuestions.personality.question;
      }
      return 'Digite **A**, **B**, **C** ou **D**! üòä';
    }

    if (conversationState === 'profiling_personality') {
      const answer = msg.toUpperCase().replace(/[^ABCD]/g, '');
      if (['A', 'B', 'C', 'D'].includes(answer)) {
        setLearningProfile(prev => ({ ...prev, personality: profileQuestions.personality.profiles[answer] }));
        setConversationState('profiling_motivation');
        addXP(15, 'Personalidade');
        return profileQuestions.motivation.question;
      }
      return 'Digite **A**, **B**, **C** ou **D**! üòä';
    }

    if (conversationState === 'profiling_motivation') {
      const answer = msg.toUpperCase().replace(/[^ABCD]/g, '');
      if (['A', 'B', 'C', 'D'].includes(answer)) {
        setLearningProfile(prev => ({ ...prev, motivationType: profileQuestions.motivation.profiles[answer] }));
        setConversationState('choosing_level');
        addXP(25, 'Perfil completo');
        return `üéâ **PERFIL COMPLETO!**\n\nSeu n√≠vel?\n\nüå± **1** - Iniciante\nüåø **2** - B√°sico\nüå≥ **3** - Intermedi√°rio\nüöÄ **4** - Avan√ßado`;
      }
      return 'Digite **A**, **B**, **C** ou **D**! üòä';
    }

    if (conversationState === 'choosing_level') {
      if (['1', '2', '3', '4'].includes(msg)) {
        const levels = { '1': 'iniciante', '2': 'basico', '3': 'intermediario', '4': 'avancado' };
        setUserLevel(levels[msg]);
        setConversationState('super_menu');
        addXP(30, 'Pronto!');
        return `‚ú® **CONFIGURADO, ${userName}!**\n\nDigite **menu** para ver op√ß√µes!`;
      }
      return 'Digite **1**, **2**, **3** ou **4**! üòä';
    }

    // Super modos
    if (superMode === 'ai-chat') {
      if (msg === 'sair' || msg === 'voltar') {
        setSuperMode(null);
        return 'üëç Voltando! Digite **menu**! üéØ';
      }
      
      const response = await getSmartResponse(userMsg, 'Chat livre');
      addXP(10, 'Chat');
      return `${apiMode === 'ai' ? 'ü§ñ' : 'üß†'} **Resposta:**\n\n${response}\n\nüí¨ Continue ou **sair**!`;
    }

    if (superMode === 'code-analyzer') {
      if (msg === 'sair' || msg === 'voltar') {
        setSuperMode(null);
        return 'üëç Saindo! Digite **menu**! üéØ';
      }
      
      if (msg.length < 20) {
        return 'üìã Cole seu c√≥digo/config aqui!\n\nOu **sair** para voltar.';
      }
      
      const analysis = analyzeCode(userMsg);
      addXP(30, 'An√°lise');
      return `${analysis}\n\nüìã Outro c√≥digo ou **sair**!`;
    }

    if (superMode === 'script-gen') {
      if (msg === 'sair' || msg === 'voltar') {
        setSuperMode(null);
        return 'üëç Saindo! Digite **menu**! üéØ';
      }
      
      if (msg.length < 10) {
        return 'üí° Descreva o que precisa!\n\nExemplo: "monitorar docker"\n\n**sair** para voltar.';
      }
      
      const script = generateScript(userMsg);
      addXP(50, 'Script');
      return `${script}\n\nüíª Outro ou **sair**!`;
    }

    if (superMode === 'troubleshoot') {
      if (msg === 'sair' || msg === 'voltar') {
        setSuperMode(null);
        return 'üëç Saindo! Digite **menu**! üéØ';
      }
      
      const solution = await getSmartResponse(userMsg, 'Troubleshooting');
      addXP(40, 'Problema resolvido');
      return `üêõ **SOLU√á√ÉO:**\n\n${solution}\n\nüîß Outro ou **sair**!`;
    }

    // Menu
    if (msg === 'menu' || msg === 'ajuda' || msg === 'help') {
      return `ü¶∏‚Äç‚ôÇÔ∏è **SUPER PODERES:**\n\n**1Ô∏è‚É£ CHAT ${apiMode === 'ai' ? 'ü§ñ' : 'üß†'}**\n   Comando: **chat** ou **ia**\n\n**2Ô∏è‚É£ ANALISADOR üîç**\n   Comando: **analisar**\n\n**3Ô∏è‚É£ GERADOR üõ†Ô∏è**\n   Comando: **gerar**\n\n**4Ô∏è‚É£ TROUBLESHOOT üêõ**\n   Comando: **problema**\n\n**Outros:**\n‚Ä¢ **progresso** - Ver status\n‚Ä¢ **config** - Configurar API\n\n${apiMode === 'embedded' ? 'üí° Configure API key (gratuita!) para respostas IA reais!' : '‚úÖ IA ativada!'}`;
    }

    // Ativar modos
    if (msg === 'ia' || msg === 'chat') {
      setSuperMode('ai-chat');
      return `${apiMode === 'ai' ? 'ü§ñ **IA REAL' : 'üß† **SISTEMA INTELIGENTE'} ATIVADO!**\n\nPergunte sobre Zabbix, Grafana, etc!\n\nüí¨ Sua pergunta! (**sair** para voltar)`;
    }

    if (msg === 'analisar' || msg === 'analise') {
      setSuperMode('code-analyzer');
      return `üîç **ANALISADOR ATIVADO!**\n\nCole c√≥digo/config do Zabbix/Grafana!\n\nüìã Cole aqui! (**sair**)`;
    }

    if (msg === 'gerar' || msg === 'script') {
      setSuperMode('script-gen');
      return `üõ†Ô∏è **GERADOR ATIVADO!**\n\nDescreva o que precisa!\n\nExemplo: "monitorar nginx"\n\nüíª Descreva! (**sair**)`;
    }

    if (msg === 'problema' || msg === 'bug' || msg === 'troubleshoot') {
      setSuperMode('troubleshoot');
      return `üêõ **TROUBLESHOOTER ATIVADO!**\n\nDescreva seu problema!\n\nüìù Qual problema? (**sair**)`;
    }

    if (msg === 'config' || msg === 'configurar' || msg === 'api') {
      setShowApiConfig(true);
      return `‚öôÔ∏è **CONFIGURA√á√ÉO DE API**\n\nAbri o painel de configura√ß√£o! Configure sua API key Groq gratuita para respostas IA reais!\n\n**Como obter:**\n1. Acesse: https://console.groq.com\n2. Crie conta gr√°tis\n3. Gere API key\n4. Cole aqui!\n\nDigite **fechar** para voltar.`;
    }

    if (msg === 'fechar') {
      setShowApiConfig(false);
      return 'Configura√ß√£o fechada! Digite **menu**! üéØ';
    }

    if (msg === 'progresso') {
      return `üìä **STATUS:**\n\nüèÜ XP: ${xp}\nüî• Streak: ${streak}\nüí¨ Intera√ß√µes: ${sessionData.interactions}\n${apiMode === 'ai' ? `ü§ñ IA Calls: ${sessionData.aiCallsUsed}` : 'üß† Modo: Embutido'}\n\nContinue! üí™`;
    }

    return `üòÖ N√£o entendi!\n\nDigite **menu** para op√ß√µes! ü¶∏‚Äç‚ôÇÔ∏è`;
  };

  const handleSendMessage = async () => {
    if (!input.trim() || isAiThinking) return;

    const userMessage = { type: 'user', content: input, timestamp: new Date() };
    setMessages(prev => [...prev, userMessage]);
    setInput('');

    const response = await smartRespond(input);
    addBotMessage(response, 100);
  };

  const saveApiKey = () => {
    if (apiKey.trim()) {
      localStorage.setItem('groq_api_key', apiKey);
      setApiMode('ai');
      setShowApiConfig(false);
      addSystemMessage('‚úÖ API Key salva! Modo IA ativado! ü§ñ', 'success');
    }
  };

  const removeApiKey = () => {
    localStorage.removeItem('groq_api_key');
    setApiKey('');
    setApiMode('embedded');
    setShowApiConfig(false);
    addSystemMessage('üß† Voltando para modo embutido!', 'info');
  };

  const handleReset = () => {
    setMessages([]);
    setConversationState('greeting');
    setXp(0);
    setUserName('');
    setSuperMode(null);
    setConversationHistory([]);
    addBotMessage(`üîÑ **RESET!**\n\nQual seu nome? üòä`, 0);
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-violet-900 via-purple-900 to-fuchsia-900 p-4">
      <div className="max-w-6xl mx-auto">
        {/* Header */}
        <div className="bg-slate-950/95 backdrop-blur-xl rounded-t-3xl p-6 border-b-2 border-purple-500/60 shadow-2xl">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-4">
              <div className="relative">
                <div className="absolute inset-0 bg-gradient-to-r from-purple-500 via-pink-500 to-red-500 rounded-2xl blur-lg opacity-75 animate-pulse"></div>
                <div className="relative bg-gradient-to-br from-purple-600 via-pink-600 to-red-600 p-4 rounded-2xl">
                  <Sparkles className="w-10 h-10 text-white" />
                </div>
              </div>
              <div>
                <h1 className="text-4xl font-black text-transparent bg-clip-text bg-gradient-to-r from-purple-400 via-pink-400 to-red-400">
                  ZabbiBot 3.0
                </h1>
                <p className="text-purple-300 font-bold flex items-center gap-2">
                  {apiMode === 'ai' ? 'ü§ñ Modo IA' : 'üß† Modo Embutido'}
                  {userName && <span className="text-sm">‚Ä¢ {userName}</span>}
                </p>
              </div>
            </div>
            
            <div className="flex items-center gap-3">
              <div className="text-center bg-gradient-to-br from-yellow-900/50 to-orange-900/50 px-4 py-2 rounded-xl border border-yellow-500/50">
                <div className="flex items-center gap-2 text-yellow-300">
                  <Trophy className="w-5 h-5" />
                  <span className="font-black text-lg">{xp}</span>
                </div>
                <p className="text-xs text-gray-400">XP</p>
              </div>
              
              <button
                onClick={() => setShowApiConfig(!showApiConfig)}
                className="p-3 bg-blue-600/30 hover:bg-blue-600/50 rounded-xl transition-all border border-blue-500/50"
                title="Configura√ß√µes"
              >
                <Settings className="w-5 h-5 text-blue-300" />
              </button>
              
              <button
                onClick={handleReset}
                className="p-3 bg-red-600/30 hover:bg-red-600/50 rounded-xl transition-all border border-red-500/50"
              >
                <RotateCcw className="w-5 h-5 text-red-300" />
              </button>
            </div>
          </div>
        </div>

        {/* Config Panel */}
        {showApiConfig && (
          <div className="bg-slate-900/95 backdrop-blur-xl p-6 border-b-2 border-blue-500/60">
            <h3 className="text-xl font-bold text-white mb-4 flex items-center gap-2">
              <Key className="w-6 h-6 text-blue-400" />
              Configura√ß√£o API (Opcional)
            </h3>
            <p className="text-gray-300 text-sm mb-4">
              Configure uma API key Groq <strong>GRATUITA</strong> para respostas IA reais!<br/>
              Sem API: Sistema embutido funciona perfeitamente! ‚úÖ
            </p>
            <div className="flex gap-3 mb-4">
              <input
                type="password"
                value={apiKey}
                onChange={(e) => setApiKey(e.target.value)}
                placeholder="Cole sua API key Groq aqui..."
                className="flex-1 bg-slate-800 text-white rounded-xl px-4 py-3 border border-slate-700"
              />
              <button
                onClick={saveApiKey}
                className="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-xl flex items-center gap-2"
              >
                <CheckCircle className="w-5 h-5" />
                Salvar
              </button>
              {apiMode === 'ai' && (
                <button
                  onClick={removeApiKey}
                  className="bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-xl flex items-center gap-2"
                >
                  <XCircle className="w-5 h-5" />
                  Remover
                </button>
              )}
            </div>
            <a 
              href="https://console.groq.com" 
              target="_blank" 
              rel="noopener noreferrer"
              className="text-blue-400 hover:text-blue-300 text-sm"
            >
              üîó Obter API key gratuita no Groq ‚Üí
            </a>
          </div>
        )}

        {/* Chat */}
        <div className="bg-slate-950/80 h-[500px] overflow-y-auto p-6 space-y-4">
          {messages.map((message, index) => (
            <div
              key={index}
              className={`flex ${message.type === 'user' ? 'justify-end' : message.type === 'system' ? 'justify-center' : 'justify-start'}`}
            >
              <div
                className={`max-w-[85%] rounded-2xl p-4 shadow-xl ${
                  message.type === 'user'
                    ? 'bg-gradient-to-r from-blue-600/90 to-purple-600/90 text-white'
                    : message.type === 'system'
                    ? message.systemType === 'success' 
                      ? 'bg-green-900/70 text-green-200 border border-green-500/50'
                      : 'bg-blue-900/70 text-blue-200 border border-blue-500/50'
                    : 'bg-slate-900/90 text-gray-100 border border-slate-700/50'
                }`}
              >
                <div className="prose prose-invert prose-sm max-w-none whitespace-pre-wrap">
                  {message.content}
                </div>
                <p className="text-xs text-gray-500 mt-2 opacity-70">
                  {message.timestamp.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}
                </p>
              </div>
            </div>
          ))}
          
          {isAiThinking && (
            <div className="flex justify-start">
              <div className="bg-purple-900/80 rounded-2xl p-4 border border-purple-500/50">
                <div className="flex items-center gap-3">
                  <div className="animate-spin">
                    <Brain className="w-5 h-5 text-purple-300" />
                  </div>
                  <p className="text-purple-200">Pensando...</p>
                </div>
              </div>
            </div>
          )}
          
          <div ref={messagesEndRef} />
        </div>

        {/* Input */}
        <div className="bg-slate-950/95 rounded-b-3xl p-5 border-t-2 border-purple-500/60">
          <div className="flex gap-3">
            <input
              type="text"
              value={input}
              onChange={(e) => setInput(e.target.value)}
              onKeyPress={(e) => e.key === 'Enter' && handleSendMessage()}
              placeholder="Digite sua mensagem..."
              disabled={isAiThinking}
              className="flex-1 bg-slate-900/90 text-white rounded-2xl px-5 py-4 focus:outline-none focus:ring-2 focus:ring-purple-500 border border-slate-800/50"
            />
            <button
              onClick={handleSendMessage}
              disabled={isAiThinking}
              className="bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white rounded-2xl px-8 py-4 flex items-center gap-2 font-bold disabled:opacity-50"
            >
              <Send className="w-5 h-5" />
              Enviar
            </button>
          </div>
          
          <div className="flex gap-2 mt-3 flex-wrap">
            <button onClick={() => setInput('menu')} className="text-xs bg-slate-800/60 hover:bg-slate-700 text-gray-300 px-3 py-2 rounded-lg border border-slate-700/50">
              <Rocket className="w-3 h-3 inline mr-1" /> Menu
            </button>
            <button onClick={() => setInput('chat')} className="text-xs bg-slate-800/60 hover:bg-slate-700 text-gray-300 px-3 py-2 rounded-lg border border-slate-700/50">
              <MessageSquare className="w-3 h-3 inline mr-1" /> Chat
            </button>
            <button onClick={() => setInput('analisar')} className="text-xs bg-slate-800/60 hover:bg-slate-700 text-gray-300 px-3 py-2 rounded-lg border border-slate-700/50">
              <Search className="w-3 h-3 inline mr-1" /> Analisar
            </button>
            <button onClick={() => setInput('gerar')} className="text-xs bg-slate-800/60 hover:bg-slate-700 text-gray-300 px-3 py-2 rounded-lg border border-slate-700/50">
              <Code className="w-3 h-3 inline mr-1" /> Gerar
            </button>
            <button onClick={() => setInput('progresso')} className="text-xs bg-slate-800/60 hover:bg-slate-700 text-gray-300 px-3 py-2 rounded-lg border border-slate-700/50">
              <TrendingUp className="w-3 h-3 inline mr-1" /> Status
            </button>
          </div>
        </div>
      </div>
    </div>
  );
};

export default ZabbiBotTutor;